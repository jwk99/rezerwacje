<!DOCTYPE html>
{% load crispy_forms_tags %}
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel pacjenta</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display:flex;
        }
        .sidebar {
            background: #f5f5f5;
            height:100vh;
            width:200px;
            padding:20px;
            box-sizing:border-box;
        }
        .sidebar button {
            display: block;
            width:100%;
            margin: 10px 0;
            padding: 10px;
            border: none;
            background: #ddd;
            cursor: pointer;
        }
        .sidebar button:hover {
            background: #bbb;
        }
        .content {
            flex: 1;
            padding: 20px;
        }
        .widget {
            display:none;
        }
        .widget.active {
            display: block;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="sidebar">
        <h3>Witaj, {{user.username}}</h3>
        <button onclick="showWidget('rezerwacja')">Umów wizytę</button>
        <button onclick="showWidget('wizyty')">Moje aktualne wizyty</button>
        <button onclick="showWidget('dawne_wizyty')">Poprzednie wizyty</button>
        <button onclick="showWidget('regulamin')">Regulamin</button>
        <br>
        <!--
        <a href="{% url 'logout'%}">Wyloguj</a>
        -->
        <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
            <button type="submit" style="background:#e57373; color:white;">Wyloguj</button>
        </form>    
    </div>
    <div class="content">
        <div id="rezerwacja" class="widget active">
            <h2>Umów wizytę</h2>
            <form method="post" action="{% url 'patient_dashboard' %}">
                {% csrf_token %}
                {{ form|crispy }}
                <button type="submit" class="btn btn-primary mt-2">Umów wizytę</button>
            </form>
        </div>
        <div id="wizyty" class="widget">
            <h2>Moje wizyty</h2>
            {% if appointments %}
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Godzina</th>
                            <th>Specjalizacja</th>
                            <th>Lekarz</th>
                            <th>Typ wizyty</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {%for appt in appointments %}
                            <tr>
                                <td>{{ appt.date }}</td>
                                <td>{{ appt.time }}</td>
                                <td>{{ appt.specialization.name }}</td>
                                <td>{{ appt.doctor.imie }} {{ appt.doctor.nazwisko }}</td>
                                <td>{{ appt.type.name }}</td>
                                <td>
                                    {% if appt.can_modify %}
                                        <form method="post" action="{% url 'cancel_appointment' appt.id %}" style="display:inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-danger">Odwołaj</button>
                                        </form>        
                                        <form method="get" action="#" style="display:inline;">
                                            <button type="button" class="btn btn-secondary" disabled>Przesuń</button>
                                        </form>
                                    {% else %}
                                        <span>Zmiany zablokowane (mniej niż 24h)</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                </table>
            {% else %}
            <p>Nie masz jeszcze żadnych wizyt.</p>
            {% endif %}
        </div>
        <div id="dawne_wizyty" class="widget">
            <h2>Twoje dawne wizyty</h2>
            {% if past_appointments %}
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Godzina</th>
                            <th>Specjalizacja</th>
                            <th>Lekarz</th>
                            <th>Recepta</th>
                            <th>Zalecenia</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for appt in past_appointments %}
                            <tr>
                                <td>{{ appt.date }}</td>
                                <td>{{ appt.time }}</td>
                                <td>{{ appt.doctor.imie }} {{ appt.doctor.nazwisko }}</td>
                                <td>{{ appt.specialization.name }}</td>
                                <td>{{ appt.summary.prescription }}</td>
                                <td>{{ appt.summary.recommendations }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>Brak zakończonych wizyt.</p>
            {% endif %}
        </div>
        <div id="regulamin" class="widget">
            <h2>Reulamin</h2>
            <p>Treść regulaminu serwisu</p>
        </div>
    </div>

    <script>
        function showWidget(id) {
            document.querySelectorAll(".widget").forEach(el => el.classList.remove("active"));
            document.getElementById(id).classList.add("active");
        }

        document.addEventListener('DOMContentLoaded', function() {
            const specializationField = document.querySelector('[name="specialization"]');
            const doctorField = document.querySelector('[name="doctor"]');

            if (specializationField) {
                specializationField.addEventListener('change', function() {
                    fetch(`/accounts/get_doctors/?specialization=${this.value}`)
                        .then(response => response.json())
                        .then(data => {
                            doctorField.innerHTML = '<option value="">--- Wybierz lekarza ---</option>';
                            data.forEach(function(doctor) {
                                doctorField.innerHTML += `<option value="${doctor.id}">${doctor.name}</option>`;
                            });
                        });
                });
            }
        });
    </script>


</body>
</html>